<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#000000" />
    <link rel="icon" href="data:," />
    <title>Escape from Planet X</title>
    <meta name="PlanetX" content="WebVR! • A-Frame" />
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
     
    <style>
      .audio-btn {
        position: fixed;
        top: 14px;
        right: 14px;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: #fff;
        display: grid;
        place-items: center;
        z-index: 10000;
        cursor: pointer;
        backdrop-filter: saturate(120%) blur(2px);
      }
      .audio-btn:hover {
        background: rgba(0, 0, 0, 0.7);
        border-color: rgba(255, 255, 255, 0.6);
      }
      .audio-btn:focus-visible {
        outline: 2px solid #66aaff;
        outline-offset: 2px;
      }
      .audio-btn .icon {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }
      .audio-btn .icon-pause { display: none; }
      .audio-btn[data-playing="true"] .icon-play { display: none; }
      .audio-btn[data-playing="true"] .icon-pause { display: block; }
    </style>
  </head>
  <body>
    <script>
AFRAME.registerComponent('no-fog', {
  init: function () {
    this.el.addEventListener('model-loaded', () => {
      this.el.object3D.traverse((node) => {
        if (node.material) node.material.fog = false;
      });
    });
  }
});
</script>
    <a-scene background="color: #000000" fog="type: linear; color: #330033; near: 1; far: 1500">
      <a-assets timeout="30000">
        <a-asset-item
          id="font-roboto"
          src="https://cdn.aframe.io/fonts/Roboto-msdf.json"
          crossorigin="anonymous"
        ></a-asset-item>
        <img id="font-roboto-img" src="https://cdn.aframe.io/fonts/Roboto-msdf.png" crossorigin="anonymous" />
        <a-asset-item
          id="trench"
          src="./assets/trench.glb"
          crossorigin="anonymous"
        ></a-asset-item>
        <a-asset-item
          id="starfield-gltf"
          src="./assets/starfield.gltf"
          crossorigin="anonymous"
        ></a-asset-item>
        <a-asset-item
          id="planetx-gltf"
          src="./assets/planetx2.glb"
          crossorigin="anonymous"
        ></a-asset-item>
        <a-asset-item
          id="titlex-gltf"
          src="./assets/titlex.gltf"
          crossorigin="anonymous"
        ></a-asset-item>


        <a-mixin
          id="text"
          text="shader: msdf; font: https://cdn.aframe.io/fonts/Roboto-msdf.json; fontImage: https://cdn.aframe.io/fonts/Roboto-msdf.png; align: center; color: #fff; width: 5; opacity: 0; lineHeight: 60; wrapCount: 42"
          animation__fadein="property: text.opacity; from: 0; to: 1; dur: 3000; easing: linear; autoplay: false; startEvents: fadein"
          animation__fadeout="property: text.opacity; from: 1; to: 0; dur: 3000; easing: linear; autoplay: false; startEvents: fadeout"
          animation__togglevisible="property: visible; from: false; to: true; dur: 1; autoplay: false; startEvents: show"
          animation__togglevisibleoff="property: visible; from: true; to: false; dur: 1; autoplay: false; startEvents: hide"
          position="0 1.0 -5"
          visible="false"
        ></a-mixin>
      </a-assets>

      

      <a-entity
        id="carpet"
        geometry="primitive: plane"
        position="0 0 0"
        rotation="50 0 0"
        material="shader: flat"
        animation="property: rotation; to: -310 0 0; dur: 230000; easing: linear; loop: true"
      >
        <a-entity id="rig" wasd-controls position="0 1620 0">
          <a-entity
            camera="near: 0.1; far: 5000"
            position="0 0 0"
            look-controls
          ></a-entity>

          <a-entity
            id="text1"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text2"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text3"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text4"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text5"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text6"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text7"
            mixin="text"
          ></a-entity>

          <a-entity
            id="text8"
            mixin="text"
          ></a-entity>
        </a-entity>
      </a-entity>

      <a-entity
        id="trenchWheel"
        gltf-model="#trench"
        scale="100 100 100"
        position="0 0 0">
      </a-entity>

      <a-entity
        id="starfield"
        gltf-model="#starfield-gltf"
        scale="2.5 2.5 2.5"
        no-fog
      ></a-entity>

      <a-entity
        id="planetx"
        gltf-model="#planetx-gltf"
        scale="30 30 30"
        position="0 4100 -750"
        no-fog
      ></a-entity>

      <a-entity
        id="titlex"
        gltf-model="#titlex-gltf"
        scale="300 300 300"
        position="0 3000 0"
        shadow="cast: true"
        rotation="0 0 0"
        no-fog
      ></a-entity>

      <a-entity light="type: hemisphere; color: #ff0000; groundColor: #0033cc; intensity: 1.5" position="0 2 0"></a-entity>
      <a-entity light="type: directional; color: #ffffff; intensity: 0.8; castShadow: true" position="1 3 1" rotation="-30 30 0"></a-entity>
       <!-- <a-entity light="type: point; color: #ffffff; intensity: 1.8" position="3 3600 0"></a-entity> -->
    </a-scene>
    <script>
      (function () {
        var schedule = [27000, 53000, 79000, 104000, 130000, 155000, 181000, 207000];
        var hold = 14000; // original dwell before fadeout
        var fadeInDur = 3000;
        var ids = ['text1','text2','text3','text4','text5','text6','text7','text8'];
        var texts = [
          "For the survivors, the Palipatonia became their new home — a vast ringed space station that self-replicates by harvesting metals from asteroids and small moons, expanding outward with each new cycle to form habitats, schools, and entire cities in orbit.",
          "Long ago, in a distant corner of the universe, life on planet Arthane collapsed beneath its own dying atmosphere. Dust storms scoured the surface, and the star’s light dimmed behind clouds of debris. The once-thriving civilizations faced extinction.",
          "Divided by faith and reason, the people disagreed on how to endure. Some believed the catastrophe was divine judgment — a trial of faith that promised salvation through devotion.",
          "Others turned to forbidden knowledge, ancient magic outlawed millennia before. In secret they preserved fragments of lost rituals and maps to hidden relics.",
          "When those relics were last used, they tore a rift between dimensions, unleashing a consuming force that drained the planet’s life energy before the portal was sealed.",
          "Generations later, desperate separatists tried again to restore life, but greed corrupted them. They plundered worlds for profit, were captured, and their relics destroyed.",
          "At last, Arthane died — no air, no food, no creatures. The survivors built a colossal station to flee their world and seek a new one among the stars.",
          "And so, the Palipatonia drifts through space — the final echo of a civilization that once reached too far into the dark."
        ];
        function setTexts() {
          ids.forEach(function(id, i) {
            var el = document.getElementById(id);
            if (el && texts[i]) {
              el.setAttribute('text', 'value', texts[i]);
            }
          });
        }

        function startSequence() {
          ids.forEach(function(id, i) {
            var el = document.getElementById(id);
            if (!el) return;
            setTimeout(function() {
              el.emit('show');
              el.emit('fadein');
              setTimeout(function(){ el.emit('fadeout'); }, hold);
              setTimeout(function(){ el.emit('hide'); }, hold + fadeInDur);
            }, schedule[i] || 0);
          });
        }

        function init() {
          /* no custom components needed */
          var scene = document.querySelector('a-scene');
          if (scene && !scene.hasLoaded) {
            scene.addEventListener('loaded', function () {
              setTexts();
              startSequence();
            });
          } else if (scene) {
            setTexts();
            startSequence();
          } else {
            // Fallback if scene isn't in DOM yet
            window.addEventListener('load', function() {
              var s = document.querySelector('a-scene');
              if (s && !s.hasLoaded) s.addEventListener('loaded', function () {
                setTexts();
                startSequence();
              });
              else {
                setTexts();
                startSequence();
              }
            });
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init, { once: true });
        } else {
          init();
        }
      })();
    </script>
    <button id="somaPlay" class="audio-btn" type="button"
            aria-label="Play Space Station Soma"
            title="Play Space Station Soma"
            aria-pressed="false"
            data-playing="false">
      <svg class="icon icon-play" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M8 5v14l11-7z"></path>
      </svg>
      <svg class="icon icon-pause" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>
      </svg>
    </button>

    <audio id="somaAudio" preload="none"></audio>

    <script>
      (function() {
        const btn = document.getElementById('somaPlay');
        const audio = document.getElementById('somaAudio');
        audio.crossOrigin = 'anonymous';

        // Default: Space Station Soma; Fallback: Deep Space One
        const stations = [
          { name: 'Deep Space One', url: 'https://ice6.somafm.com/deepspaceone-128-mp3' },
          { name: 'Space Station Soma', url: 'https://ice6.somafm.com/spacestation-128-mp3' }
        ];
        let currentIndex = 0;

        function setStation(i) {
          currentIndex = i;
          audio.src = stations[i].url;
          btn.setAttribute('aria-label', (audio.paused ? 'Play ' : 'Pause ') + stations[i].name);
          btn.setAttribute('title', (audio.paused ? 'Play ' : 'Pause ') + stations[i].name);
        }

        // Initialize with Space Station Soma
        setStation(0);

        function updateUi() {
          const playing = !audio.paused && !audio.ended && audio.currentTime > 0;
          btn.dataset.playing = playing ? 'true' : 'false';
          btn.setAttribute('aria-pressed', playing ? 'true' : 'false');
          btn.setAttribute('aria-label', (playing ? 'Pause ' : 'Play ') + stations[currentIndex].name);
          btn.setAttribute('title', (playing ? 'Pause ' : 'Play ') + stations[currentIndex].name);
        }

        btn.addEventListener('click', async () => {
          if (!audio.src) setStation(0);
          if (audio.paused) {
            try {
              await audio.play();
            } catch (err) {
              console.warn('Playback failed:', err);
            }
          } else {
            audio.pause();
          }
        });

        // Keyboard accessibility
        btn.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            btn.click();
          }
        });

        audio.addEventListener('playing', updateUi);
        audio.addEventListener('pause', updateUi);
        audio.addEventListener('ended', () => {
          updateUi();
          // Streams rarely end; attempt to resume.
          audio.play().catch(() => {});
        });

        // Fallback on error
        let triedFallback = false;
        audio.addEventListener('error', () => {
          console.warn('Stream error; attempting fallback station.');
          if (!triedFallback) {
            triedFallback = true;
            const next = (currentIndex + 1) % stations.length;
            setStation(next);
            audio.play().catch(err => console.warn('Fallback playback failed:', err));
          }
        });
      })();
    </script>
  </body>
</html>
